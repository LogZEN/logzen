{% extends "base.html" %}

{% block title %}Events{% endblock %}

{% block content %}

<div id="loading"></div>

<div class="row-fluid">
   	<div class="span12">
   		<div id="navi" class="btn-toolbar">
			<span id="eventcount"></span> &nbsp;
			<div class="btn-group">
				<a href="javascript:void(0);" class="btn q_tip" id="zoomoutbutton" title="Zoom out to a wider timerange">Zoom Out</a>
			</div>
			<div class="btn-group">
				<a class="btn left q_tip" title="Newer" href="javascript:void(0);" id="prevbutton">Prev</a><a class="btn right q_tip" title="Older" href="javascript:void(0);" id="nextbutton">Next</a>
			</div>
		</div>
   	</div>
</div>

<div class="row-fluid">
   	<div class="span12">
		<div id="chartdiv" style="height: 120px; width: 100%; margin: 0px auto;"></div>
   	</div>
</div>

<div class="row-fluid">
	<form action="/events/update" method="post" id="filterform" class="form-inline">
	<table id="events" class="table-condensed">
        <thead>
			<tr id="first">
				<th>time_logged</th>
				<th>host</th>
				<th>facility</th>
				<th>severity</th>
				<th>program</th>
				<th>message</th>
			</tr>
			<tr>
				<th id="column_time"><input type="text" name="filter_time" id="filter_time" class="filter" placeholder="filter" size="5" /></th>
				<th id="column_host"><input type="text" name="filter_host" id="filter_host" class="filter" placeholder="filter" size="5" {% if host %}value="{{host}}"{% endif %} /></th>
				<th id="column_facility"><input type="text" name="filter_facility" id="filter_facility" class="filter" placeholder="filter" size="5" /></th>
				<th id="column_severity"><input type="text" name="filter_severity" id="filter_severity" class="filter" placeholder="filter" size="5" /></th>
				<th id="column_program"><input type="text" name="filter_program" id="filter_program" class="filter" placeholder="filter" size="5" /></th>
				<th id="column_message"><input type="text" name="filter_message" id="filter_message" class="filter" placeholder="filter" size="5" /></th>
			</tr>
		</thead>
		
		<tbody id="tbody_content">
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
		</tbody>
	</table>
	</form>
</div>

<script type="text/javascript">//<![CDATA[
	var zoomlevel = null;
	var page = 0;
	var maxpages = 1;
	var plot = null;
	var timerange = [];
	var prevrange = new Array(1);
	for (var i = 0; i < 6; i++) {
		prevrange[i] = new Array(2);
	}
	
	/*
	 * remove a table column
	 */
	function toggleEventlistColumn(id) {
		$('td:nth-child(' + id + '),th:nth-child(' + id + ')').fadeToggle();
	}	 
	
	/*
	 * formular clear buttons
	 */
 	$(".filter").each(function() {
		$('.clearlink')
			.attr('title', 'Clear this textbox')
			.qtip({
				content: {
					text: 'Clear this textbox'
				},
				position: {
	 				my: 'top center',
	 				at: 'bottom center'
	 			},
	 			style: {
	 				classes: 'ui-tooltip-dark ui-tooltip-shadow ui-tooltip-rounded'
	 			}
			})
			.click(function() {
				$(this).prev().val('');
			})
	});
	
	 /*
	  * set the tooltip for each result row
	  */
	 function loadTooltips() {
	 	$(".event").each(function() {
	 		$(this).qtip({
	 			content: {
	 				text: 'Loading...',
	 				ajax: {
	 					url: '/events/tooltip',
	 					type: 'GET',
	 					data: { event_id: this.id },
	 					success: function(data, status) {
	 						this.set('content.text', data);
	 					}
	 				}
	 			},
	 			position: {
	 				my: 'top left',
	 				at: 'bottom center'
	 			},
	 			hide: {
	 		        fixed: true,
	 				delay: 200
	 			},
	 			style: {
	 				classes: 'ui-tooltip-dark ui-tooltip-shadow ui-tooltip-rounded'
	 			}
	 		});
	 	});

		$('.q_tip').qtip({
			content: {
				attr: 'title'
			},
			position: {
 				my: 'top center',
 				at: 'bottom center'
 			},
 			style: {
 				classes: 'ui-tooltip-dark ui-tooltip-shadow ui-tooltip-rounded'
 			}
		});
	 }

	/*
	 *	load graph
	 */
	function updateGraph () {
	    function onDataReceived(series) {
	    	zoomlevel = series.metadata['zoomlevel']
	    	data = []
	    	tick = []
	    	tickrange = []
	    	i = 0
	    	for (s in series.data) {
	    		console.log(i, parseInt(series.data[s]), s);
	    		data.push([i, parseInt(series.data[s])]);
	    		tick.push([i, s]);
	    		i++;
	    	}
	    	tick.push([i, series.metadata['maxtime']])
	    	
	    	console.log(tick.length)
    		tickrange.push(tick[0]);
	    	tickrange.push(tick[Math.round((tick.length - 1) / 2)])
	    	tickrange.push(tick[tick.length - 1])
	    	
	    	plot = $.plot($('#chartdiv'), [data], options = {
	    		xaxis: {
	    			ticks: tickrange,
				},
	    		bars: {
	    		      show: true,
	    		      lineWidth: 1,
	    		      fill: true,
	    		      fillColor: { colors: ["#729fcf", "#3465af"] }
				},
				grid: { 
					hoverable: true, 
					autoHighlight: true 
				},
				tooltip: true,
				tooltipOpts: {
					content: "%y",
					defaultTheme:  false
				},
				colors: ["#204a87"],
				selection: { mode: "x" }
			});
	    }
	}

	/*
	 *	update the content
	 */
	function updateAction(event, ranges) {
		var $form = $('#filterform');
        var params = {};
        
        params['host'] = $form.find('input[name="filter_host"]').val();
        params['facility'] = $form.find('input[name="filter_facility"]').val();
        params['severity'] = $form.find('input[name="filter_severity"]').val();
        params['tag'] = $form.find('input[name="filter_tag"]').val();
        params['program'] = $form.find('input[name="filter_program"]').val();
        params['message'] = $form.find('input[name="filter_message"]').val();
		
        if(ranges) {
        	console.log(zoomlevel)
        	prevrange[zoomlevel]['start_time'] = timerange['start_time']
        	prevrange[zoomlevel]['end_time'] = timerange['end_time']
        	timerange['start_time'] = tick[Math.floor(ranges.xaxis.from)][1];
        	timerange['end_time'] = tick[Math.ceil(ranges.xaxis.to)][1];
        }
		params['start_time'] = timerange['start_time'];
		params['end_time'] = timerange['end_time'];

	    $.ajax({
	        url: $('#filterform').attr('action'),
	        method: 'POST',
	        data: params,
	        dataType: 'json', 
	        success: handleResult,
	        beforeSend: function(){
	        	$("#loading").show();
	       },
	    });

		function handleResult(s) {
        	$("#loading").hide();
        	
        	// set current page
        	page = s.metadata['page'];
        	maxpages = s.metadata['maxpages'];
        	
			// update eventcount
			if (s.metadata['event_count'] < 10000) {
				var event_count_label = s.metadata['event_count']
			} else {
				var event_count_label = '<span class="q_tip" title="' + 
					s.metadata['event_count'] + ' events">quite a few</span>'
			}
			$('#eventcount').empty().append(s.metadata['event_first'] + " - " + 
					s.metadata['event_last'] + " of " + event_count_label)

			if (page > 0) {
				$('#prevbutton').removeAttr("disabled");
			} else {
				$('#prevbutton').attr("disabled", "disabled");
			}

        	if (page + 1 < maxpages) {
				$('#nextbutton').removeAttr("disabled");
			} else {
				$('#nextbutton').attr("disabled", "disabled");
			}
			// update events
			var rows = ""
			if (s.events.length > 0) {
				for (var i = 0; i < s.events.length; i++) {
					var object = s.events[i];
					rows += '<tr>';
					rows += '<td class="event" id="' + object['id'] + '">' + object['reported_time'] + '</td>';
					rows += '<td class="event" id="' + object['id'] + '"><a href="javascript:void(0)" onclick="$(\'#filter_host\').val($(this).html()); updateAction();">' + object['host'] + '</a></td>';
					rows += '<td class="event color_' + object['level'] + '" id="' + object['id'] + '"><a href="javascript:void(0)" onclick="$(\'#filter_facility\').val($(this).html()); updateAction();">' + object['facility'] + '</a></td>';
					rows += '<td class="event" id="' + object['id'] + '"><a href="javascript:void(0)" onclick="$(\'#filter_severity\').val($(this).html()); updateAction();">' + object['severity'] + '</a></td>';
					rows += '<td class="event" id="' + object['id'] + '"><a href="javascript:void(0)" onclick="$(\'#filter_program\').val($(this).html()); updateAction();">' + object['program'] + '</a></td>';
					rows += '<td class="event" id="' + object['id'] + '"><a href="javascript:void(0)" onclick="$(\'#filter_message\').val($(this).html()); updateAction();">' + object['message'] + '</a></td>';
					rows += '</tr>';
				}
			} else {
				rows = '<tr><td colspan="6" id="noresults">No events found.</td></tr>'
			}
			$('tbody').empty().append(rows);
			$('html, body').animate({scrollTop:0}, 'fast');

			// update tooltips
			loadTooltips();

			// update graph
	    	zoomlevel = s.metadata['zoom']
	    	data = []
	    	tick = []
	    	tickrange = []
	    	
	    	if (s.eventcount.length > 0) {
				for (var i = 0; i < s.eventcount.length; i++) {
					var object = s.eventcount[i];
	    			data.push([i, parseInt(object['count'])]);
	    			tick.push([i, object['time']]);
				}
	    	}
	    	tick.push([i, s.metadata['maxtime']])
	    	
    		tickrange.push(tick[0]);
	    	tickrange.push(tick[Math.round((tick.length - 1) / 2)])
	    	tickrange.push(tick[tick.length - 1])
	    	
	    	plot = $.plot($('#chartdiv'), [data], options = {
	    		xaxis: {
	    			ticks: tickrange,
				},
	    		bars: {
	    		      show: true,
	    		      lineWidth: 1,
	    		      fill: true,
	    		      fillColor: { colors: ["#729fcf", "#3465af"] }
				},
				grid: { 
					hoverable: true, 
					autoHighlight: true 
				},
				tooltip: true,
				tooltipOpts: {
					content: "%y",
					defaultTheme:  false
				},
				colors: ["#204a87"],
				selection: { mode: "x" }
			});
		}
	}
	// update buttons


	/*
	 *	add actions
	 */
	$('#filterform').bind('keyup', function() {
		updateAction();
	});
	
    $('#zoomoutbutton').click(function (e) {
        e.preventDefault();
    	if (zoomlevel > 0) {
        	timerange['start_time'] = prevrange[zoomlevel - 1]['start_time']
        	timerange['end_time'] = prevrange[zoomlevel - 1]['end_time']
        }
        updateAction();
    });
    
	$('#prevbutton').click(function() {
		if(page > 0) {
			var action = '/events/update?page=' + (page - 1)
			$('#filterform').get(0).setAttribute('action', action);
			updateAction();
		}
	});
	
	$('#nextbutton').click(function() {
		if(page + 1 < maxpages) {
			var action = '/events/update?page=' + (page + 1)
			$('#filterform').get(0).setAttribute('action', action);
			updateAction();
		}
	});
	
	$("#chartdiv").bind("plotselected", updateAction);
	
	/*
	 *	fire the initial event
	 */
	 $.plot($('#chartdiv'), [[[0,0], [0,0]]], {
		bars: {
		      show: true,
		      lineWidth: 1,
		      fill: true,
		      fillColor: { colors: ["#729fcf", "#3465af"] }
		},
		colors: ["#204a87"],
		selection: { mode: "x" }
	});
	 
	updateAction(); 
	    
//]]></script>
	
{% endblock %}